<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LCD OCR â€“ testiversio</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; text-align:center; margin:0; padding:10px; }
  video { width:100%; max-width:400px; border:1px solid #ccc; }
  canvas { display:none; }
  #result { font-size:1.2em; margin-top:10px; }
  button { margin:5px; padding:10px; font-size:1em; }
</style>
</head>
<body>

<h2>LCD OCR â€“ testiversio</h2>

<video id="video" autoplay playsinline muted></video>
<canvas id="raw"></canvas>
<canvas id="bw"></canvas>

<div>
  <button id="torchBtn">ðŸ”¦ Valo</button>
  <button id="scanBtn">ðŸ“¸ Skannaa tulos</button>
</div>

<div id="result">Ei skannausta vielÃ¤</div>

<script>
const video = document.getElementById('video');
const raw = document.getElementById('raw');
const bw = document.getElementById('bw');
const result = document.getElementById('result');
const scanBtn = document.getElementById('scanBtn');
const torchBtn = document.getElementById('torchBtn');

let stream, track;

// ðŸ”¹ KÃ¤ynnistÃ¤ kamera
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = stream;
    track = stream.getVideoTracks()[0];
    await video.play();
    autoScan(); // KÃ¤ynnistÃ¤ automaattinen skannaus
  } catch(e) {
    alert("Kamera ei kÃ¤ynnistynyt: " + e.message);
  }
}

// ðŸ”¹ Torch-nappi
torchBtn.onclick = () => {
  if(!track) return;
  const cap = track.getCapabilities();
  if(cap.torch) {
    track.applyConstraints({ advanced:[{torch: true}] });
  } else alert("Torch ei tuettu tÃ¤ssÃ¤ laitteessa");
};

// ðŸ”¹ Scan-nappi (manuaalinen)
scanBtn.onclick = () => scan();

// ðŸ”¹ Automaatio: skannaa joka 2 sekuntia
function autoScan() {
  scan();
  setTimeout(autoScan, 2000);
}

// ðŸ”¹ Scan-funktio
async function scan() {
  if(video.readyState < 2) return;

  const w = video.videoWidth;
  const h = video.videoHeight;

  // ðŸ”¹ Rajaus keskelle LCD:Ã¤
  const cropX = w*0.3, cropY = h*0.25, cropW = w*0.4, cropH = h*0.35;

  raw.width = bw.width = cropW;
  raw.height = bw.height = cropH;

  const rctx = raw.getContext('2d');
  const bctx = bw.getContext('2d');

  // ðŸ”¹ PiirrÃ¤ rajattu raakakuva
  rctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

  // ðŸ”¹ Threshold / kontrasti LCD-nÃ¤ytÃ¶lle
  const img = rctx.getImageData(0,0,cropW,cropH);
  const d = img.data;
  for(let i=0; i<d.length; i+=4){
    const gray = d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114;
    const v = gray < 160 ? 255 : 0; // invert + matala kynnys
    d[i]=d[i+1]=d[i+2]=v;
  }
  bctx.putImageData(img,0,0);

  result.textContent = "OCR kÃ¤ynnissÃ¤â€¦";

  // ðŸ”¹ OCR vain numeroille, single line
  try {
    const { data: { text } } = await Tesseract.recognize(
      bw,
      'eng',
      {
        tessedit_char_whitelist: '0123456789',
        classify_bln_numeric_mode: 1,
        psm: 7
      }
    );
    const out = text.replace(/\D/g,'').trim();
    result.textContent = out ? "OCR: " + out : "Ei tunnistettu";
  } catch(e) {
    result.textContent = "OCR-virhe";
    console.error(e);
  }
}

// ðŸ”¹ KÃ¤ynnistÃ¤ kamera sivun latauksessa
window.onload = startCamera;
</script>

</body>
</html>

