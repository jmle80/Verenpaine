<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keto-Opas v4.0 (S-Linkit)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0; padding: 0; padding-bottom: 100px;
        }
        
        /* Virheenk√§sittely */
        #error-box { display: none; background: #e74c3c; color: white; padding: 15px; position: fixed; top: 0; width: 100%; z-index: 10000; }
        
        /* UI Elementit */
        .version-tag { background: #2980b9; color: white; padding: 10px; text-align: center; font-weight: bold; }
        header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
        h1, h2 { margin: 0 0 10px 0; }
        button { cursor: pointer; }

        .view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .view.active { display: block; }

        .shift-toggle-container { display: flex; margin: 15px 0; }
        .shift-btn { flex: 1; padding: 12px; border: 2px solid #2c3e50; background: white; color: #2c3e50; font-weight: bold; }
        .shift-btn.active { background: #2c3e50; color: white; }

        .day-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .ctrl-btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 1.2rem; }

        .meal-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #27ae60; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .meal-time { color: #7f8c8d; font-size: 0.9rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .meal-title { font-size: 1.1rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        details { border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; }
        summary { font-weight: bold; color: #27ae60; outline: none; }
        .recipe-text { margin-top: 10px; line-height: 1.5; font-size: 0.95rem; }

        /* KAUPPALISTA S-LINKEILL√Ñ */
        .shop-item {
            background: white; padding: 10px; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 5px; border: 1px solid #ddd;
        }
        .shop-item-left { display: flex; align-items: center; flex: 1; }
        .shop-item.checked span { text-decoration: line-through; color: #999; }
        .shop-item input { transform: scale(1.5); margin-right: 10px; }
        
        /* S-Kaupat Haku-nappi */
        .s-btn {
            background-color: #009d4a; /* S-ryhm√§n vihre√§ */
            color: white; border: none; padding: 5px 10px;
            border-radius: 4px; font-size: 0.8rem; font-weight: bold;
            margin-left: 10px; text-decoration: none;
        }

        .total-box { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-radius: 8px; margin-bottom: 20px; }
        .reset-btn { width: 100%; padding: 15px; background: #c0392b; color: white; border: none; font-weight: bold; font-size: 1rem; border-radius: 5px; margin-top: 20px; }

        .nav-tabs { position: fixed; bottom: 0; width: 100%; display: flex; background: white; border-top: 1px solid #ccc; height: 60px; }
        .nav-btn { flex: 1; border: none; background: white; font-weight: bold; color: #7f8c8d; }
        .nav-btn.active { color: #2c3e50; border-top: 4px solid #27ae60; }

        /* Y√∂tila */
        body.night-mode { background-color: #222; color: #ddd; }
        body.night-mode .meal-card, body.night-mode .shop-item, body.night-mode .day-controls, body.night-mode .nav-tabs { background: #333; color: #fff; }
        body.night-mode .nav-btn { background: #333; }
        body.night-mode .meal-title { color: #f1c40f; }
        body.night-mode summary { color: #f1c40f; }
        body.night-mode .shift-btn { background: #333; color: #f1c40f; border-color: #f1c40f; }
        body.night-mode .shift-btn.active { background: #f1c40f; color: #222; }
    </style>
</head>
<body>

    <div id="error-box"></div>
    <div class="version-tag">Versio 4.0 - S-Kaupat Linkit</div>
    <header><h1>Keto-Opas 46v</h1></header>

    <div id="view-day" class="view active">
        <div class="shift-toggle-container">
            <button class="shift-btn active" id="btn-morning" onclick="app.setShift('morning')">‚òÄ Aamuvuoro</button>
            <button class="shift-btn" id="btn-night" onclick="app.setShift('night')">üåô Y√∂vuoro</button>
        </div>

        <div class="day-controls">
            <button class="ctrl-btn" onclick="app.changeDay(-1)">&#8592;</button>
            <h2 id="day-title">Maanantai</h2>
            <button class="ctrl-btn" onclick="app.changeDay(1)">&#8594;</button>
        </div>

        <div id="meals-list"></div>
    </div>

    <div id="view-shop" class="view">
        <h2>Ostoslista</h2>
        <div class="total-box">Yhteens√§: <span id="total-price">0.00</span> ‚Ç¨</div>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px; text-align: center;">
            Paina <span style="background:#009d4a; color:white; padding:2px 5px; border-radius:3px;">S-Haku</span> avataksesi tuotteen S-kaupat.fi:ss√§.
        </div>
        <div id="shop-list"></div>
        <button class="reset-btn" onclick="app.resetShop()">Tyhjenn√§ lista</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" id="nav-day" onclick="app.switchTab('day')">P√§iv√§ohjelma</button>
        <button class="nav-btn" id="nav-shop" onclick="app.switchTab('shop')">Kauppalista</button>
    </div>

<script>
window.onerror = function(msg, url, line) {
    var box = document.getElementById('error-box'); box.style.display = 'block';
    box.innerText = "VIRHE: " + msg; return false;
};

// --- DATA ---
// "s": Hakusana S-kauppaan (optimoitu l√∂ytym√§√§n)
const DATA = {
    week: [
        { day: "Maanantai", meals: [
            { n: "Mustikkasmoothie / Munat", r: "1dl mustikoita, ¬Ω avokado, 1dl kermaa. TAI 2 paistettua munaa." },
            { n: "Tonnikalasalaatti", r: "1 prk tonnikalaa, salaattia, kurkkua, 1 muna, p√§hkin√∂it√§, majoneesia." },
            { n: "Uunilohi & Parsakaali", r: "200g lohta uuniin (200¬∞C 20min). H√∂yrytetty parsakaali voilla." },
            { n: "Turkkilainen Jogurtti", r: "2 dl turkkilaista jogurttia, ripaus marjoja tai p√§hkin√∂it√§." }
        ]},
        { day: "Tiistai", meals: [
            { n: "Smoothie / Munat", r: "Ks. maanantai." },
            { n: "Uunilohen j√§m√§t", r: "Maanantain lohta majoneesilla." },
            { n: "Kanaa & Kukkakaalimuusia", r: "2 paistileikett√§ uuniin (35min). Keit√§ kukkakaali, soseuta voin ja kerman kanssa." },
            { n: "Juustosiivut", r: "3-4 siivua paksua juustoa ja kurkkutikkuja." }
        ]},
        { day: "Keskiviikko", meals: [
            { n: "Smoothie / Munat", r: "Ks. maanantai." },
            { n: "Kanaa & Muusia", r: "Tiistain j√§m√§t." },
            { n: "Jauhelihapihvit", r: "400g jauhelihaa (tee 4 pihvi√§, sy√∂ 2). Paista voissa. Lis√§ksi vihreit√§ papuja." },
            { n: "P√§hkin√§t & Tee", r: "Kourallinen (n. 30g) p√§hkin√∂it√§ ja iso kupillinen teet√§." }
        ]},
        { day: "Torstai", meals: [
            { n: "Smoothie / Munat", r: "Ks. maanantai." },
            { n: "Jauhelihapihvit", r: "2 eilist√§ pihvi√§, salaattia, oliivi√∂ljy√§." },
            { n: "Tonnikalavuoka", r: "Kes√§kurpitsaa, 2 prk tonnikalaa, 2dl kermaa, juustoa. Uuni 200¬∞C 25min." },
            { n: "Smoothien loppu", r: "Pieni mustikkasmoothie (puolikas annos)." }
        ]},
        { day: "Perjantai", meals: [
            { n: "Tuhti munakas", r: "3 munaa, kermaa, juustoa pannulle." },
            { n: "Smoothie / Kevyt", r: "Mustikkasmoothie." },
            { n: "Kermainen Pekoni-Kana", r: "150g kanaa, pekonia. Paista. Lis√§√§ 2dl kermaa. Hauduta. Parsakaalia." },
            { n: "Kermavaahto & Marjat", r: "1 dl kermavaahtoa (makeutusainetta jos haluat) ja mustikoita." }
        ]},
        { day: "Lauantai", meals: [
            { n: "Brunssi", r: "Munakokkelia, pekonia, kahvia." },
            { n: "Kanasalaatti", r: "Perjantain kanan j√§m√§t salaatilla, avokadoa, p√§hkin√∂it√§." },
            { n: "Wingsit", r: "500g siipi√§ uuniin. Dippaa majoneesiin. Kurkkutikkuja." },
            { n: "Leikkelelautanen", r: "Muutama siivu kinkkua/meetvurstia ja juustoa." }
        ]},
        { day: "Sunnuntai", meals: [
            { n: "Smoothie", r: "Mustikkasmoothie." },
            { n: "Wingsien j√§m√§t", r: "Loput siivet." },
            { n: "Keto-Pizza (tai Tankkaus)", r: "Pohja: 2 munaa+3dl juustoa (uuni 10min). T√§yte: pyree, kana, juusto. (Jos Y√∂vuoro: Sy√∂ klo 19)." },
            { n: "Iltapala / Y√∂ev√§s", r: "Turkkilainen jogurtti p√§hkin√∂ill√§." }
        ]}
    ],
    shop: [
        { c: "HeVi", i: [
            { n: "J√§√§salaatti", s: "kotimaista j√§√§salaatti", p: 1.49 },
            { n: "Kurkku (2)", s: "kotimaista kurkku", p: 1.80 },
            { n: "Tomaatti", s: "kotimaista tomaatti", p: 2.49 },
            { n: "Parsakaali 400g", s: "parsakaali pakaste", p: 1.19 },
            { n: "Kukkakaali", s: "kukkakaali", p: 2.99 },
            { n: "Avokadoja", s: "avokado", p: 2.95 },
            { n: "Kes√§kurpitsa", s: "kes√§kurpitsa", p: 1.20 },
            { n: "Sipuli", s: "sipuli", p: 1.50 },
            { n: "Vihr. Pavut", s: "rainbow vihre√§t pavut", p: 0.95 }
        ]},
        { c: "Liha/Kala", i: [
            { n: "Jauheliha 400g", s: "kotimaista naudan jauheliha 17", p: 3.99 },
            { n: "Broileri paistileike", s: "kotimaista broileri paistileike", p: 4.50 },
            { n: "Broileri suikale", s: "kotimaista broileri fileesuikale", p: 4.29 },
            { n: "Siivet 1kg", s: "kotimaista broileri siivet", p: 3.99 },
            { n: "Kirjolohi 600g", s: "kotimaista kirjolohifilee", p: 9.90 },
            { n: "Pekoni", s: "rainbow pekoni", p: 1.39 }
        ]},
        { c: "Maito/Munat", i: [
            { n: "Munat 15kpl", s: "kotimaista kananmuna s15", p: 2.59 },
            { n: "Kuohukerma 1L", s: "kotimaista kuohukerma", p: 4.19 },
            { n: "Voi 500g", s: "kotimaista voi", p: 3.49 },
            { n: "Juustoraaste 500g", s: "xtra juustoraaste", p: 3.95 },
            { n: "Turkkilainen Jogurtti", s: "rainbow turkkilainen jogurtti", p: 2.65 }
        ]},
        { c: "Muut", i: [
            { n: "Tonnikala (4prk)", s: "rainbow tonnikala √∂ljyss√§", p: 5.95 },
            { n: "P√§hkin√§t", s: "rainbow saksanp√§hkin√§", p: 3.49 },
            { n: "Tomaattipyree", s: "rainbow tomaattipyree", p: 0.60 },
            { n: "Majoneesi", s: "rainbow majoneesi", p: 2.15 },
            { n: "Oliivi√∂ljy", s: "rainbow oliivi√∂ljy", p: 4.50 }
        ]}
    ]
};

// --- LOGIIKKA ---
const app = {
    state: { dayIdx: 0, shift: 'morning', checked: [] },

    init: function() {
        try {
            const s = localStorage.getItem('ketoState_v4');
            if (s) this.state = JSON.parse(s);
        } catch(e) {}
        this.renderDay(); this.renderShop(); this.updateUI();
    },

    save: function() { try { localStorage.setItem('ketoState_v4', JSON.stringify(this.state)); } catch(e) {} },

    changeDay: function(dir) {
        this.state.dayIdx += dir;
        if (this.state.dayIdx < 0) this.state.dayIdx = 6;
        if (this.state.dayIdx > 6) this.state.dayIdx = 0;
        this.save(); this.renderDay();
    },

    setShift: function(mode) {
        this.state.shift = mode; this.save();
        this.updateUI(); this.renderDay();
    },

    switchTab: function(tab) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + tab).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-' + tab).classList.add('active');
    },

    toggleShopItem: function(name) {
        const idx = this.state.checked.indexOf(name);
        if (idx > -1) this.state.checked.splice(idx, 1);
        else this.state.checked.push(name);
        this.save(); this.renderShop();
    },

    resetShop: function() {
        if(confirm("Tyhjennet√§√§nk√∂ lista?")) {
            this.state.checked = []; this.save(); this.renderShop();
        }
    },

    updateUI: function() {
        const isNight = (this.state.shift === 'night');
        document.body.className = isNight ? 'night-mode' : '';
        document.getElementById('btn-morning').className = isNight ? 'shift-btn' : 'shift-btn active';
        document.getElementById('btn-night').className = isNight ? 'shift-btn active' : 'shift-btn';
    },

    renderDay: function() {
        const d = DATA.week[this.state.dayIdx];
        document.getElementById('day-title').innerText = d.day;
        const list = document.getElementById('meals-list');
        list.innerHTML = '';

        let order = [0, 1, 2, 3];
        let labels = ["Aamupala (07:00)", "Lounas (11:00)", "P√§iv√§llinen (16:30)", "Iltapala (20:30)"];
        const isWeekend = (this.state.dayIdx === 5 || this.state.dayIdx === 6);

        if (this.state.shift === 'night' && !isWeekend) {
            order = [0, 2, 1, 3];
            labels = ["Her√§√§minen (15:00)", "Tankkaus (19:00)", "Y√∂ev√§s (01:00)", "Aamupala/Uni (07:00)"];
        }
        if (this.state.dayIdx === 6 && this.state.shift === 'night') {
             labels = ["Vapaa Aamu", "Lounas", "TANKKAUS Y√ñH√ñN (19:00)", "Y√∂ev√§s (T√∂ihin)"];
        }

        order.forEach((mealIdx, i) => {
            const m = d.meals[mealIdx];
            if (!m) return;
            const div = document.createElement('div');
            div.className = 'meal-card';
            div.innerHTML = `
                <span class="meal-time">${labels[i]}</span>
                <div class="meal-title">${m.n}</div>
                <details><summary>Ohje</summary><div class="recipe-text">${m.r}</div></details>
            `;
            list.appendChild(div);
        });
    },

    renderShop: function() {
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        let total = 0;

        DATA.shop.forEach(cat => {
            const h3 = document.createElement('h3');
            h3.innerText = cat.c; h3.style.marginTop = "15
